# AI Activity Generation Endpoint
# Add this to main.py or create as separate module

from fastapi import FastAPI, Depends, HTTPException, status
from fastapi.middleware.cors import CORSMiddleware
from sqlalchemy.orm import Session
from sqlalchemy import func
from typing import List, Optional
import uuid
import asyncio
import json
from datetime import datetime, timedelta
import logging

# Import AI Activity Generator
try:
    from ai_activity_generator import generate_ai_activities
    AI_GENERATOR_AVAILABLE = True
    print("‚úÖ AI Activity Generator imported successfully!")
except ImportError as e:
    AI_GENERATOR_AVAILABLE = False
    print(f"‚ö†Ô∏è AI Activity Generator not available: {e}")

# Import existing database and models
from database import SessionLocal, get_db, create_tables
import models, schemas
from auth_system import AuthSystem
import pivot_engine
from websocket_manager import connection_manager

# Setup logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Initialize database
create_tables()
auth_system = AuthSystem()

app = FastAPI(title="AI Trip Management API", version="1.0.0")

# CORS Configuration (same as main.py)
origins = [
    "http://localhost:3000",  # React Default
    "http://localhost:5173",  # Vite React Default
    "http://localhost:8000",  # FastAPI default
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Dependency to get database session
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# =============================================================================
# AI ACTIVITY GENERATION ENDPOINT
# =============================================================================

@app.post("/trips/{trip_id}/generate-activities", response_model=List[schemas.ActivityResponse])
async def generate_trip_activities(trip_id: int, request: schemas.AIGenerateActivitiesRequest, db: Session = Depends(get_db)):
    """
    Generate AI-powered activities for a trip
    
    This endpoint uses AI to create contextual activities based on:
    - Trip duration and preferences
    - Location type (urban, nature, coastal, mountain)
    - Group size and budget level
    - Time of day for activities
    """
    
    # Verify trip exists and user has access
    trip = db.query(models.Trip).filter(models.Trip.id == trip_id).first()
    if not trip:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Trip not found"
        )
    
    # Prepare context for AI activity generation
    trip_context = {
        "trip_name": trip.name,
        "duration": request.duration,
        "location_type": request.location_type,
        "group_size": request.group_size,
        "preferences": request.preferences,
        "budget_level": request.budget_level,
        "time_of_day": request.time_of_day,
        "weather_preference": request.weather_preference,
        "accessibility_needs": request.accessibility_needs,
        "special_interests": request.special_interests
    }
    
    try:
        # Generate AI-powered activities
        if AI_GENERATOR_AVAILABLE:
            ai_activities = generate_ai_activities(trip_context)
            logger.info(f"Generated {len(ai_activities)} AI activities for trip {trip_id}")
        else:
            raise ValueError("AI Activity Generator not available")
        
        # Save activities to database
        saved_activities = []
        for activity_data in ai_activities:
            new_activity = models.Activity(
                trip_id=trip_id,
                title=activity_data["title"],
                type=activity_data["type"],
                start_time=datetime.fromisoformat(activity_data["start_time"].replace('Z', '+00:00')),
                end_time=datetime.fromisoformat(activity_data["end_time"].replace('Z', '+00:00')),
                location_name=activity_data["location_name"],
                address=activity_data["address"],
                lat=activity_data["lat"],
                lng=activity_data["lng"],
                description=activity_data["description"],
                estimated_cost=activity_data["estimated_cost"],
                capacity=activity_data["capacity"],
                is_ai_generated=True,
                status="pending"
            )
            
            db.add(new_activity)
            saved_activities.append(new_activity)
        
        db.commit()
        
        # Refresh all activities to get their IDs
        for activity in saved_activities:
            db.refresh(activity)
        
        logger.info(f"Successfully saved {len(saved_activities)} AI-generated activities to database")
        
        return saved_activities
        
    except Exception as e:
        logger.error(f"AI activity generation failed: {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to generate AI activities: {str(e)}"
        )

# =============================================================================
# UTILITY ENDPOINT FOR AI STATUS
# =============================================================================

@app.get("/api/ai/status")
async def get_ai_status():
    """Get AI service status and capabilities"""
    return {
        "ai_enabled": AI_GENERATOR_AVAILABLE,
        "ai_services": {
            "activity_generation": AI_GENERATOR_AVAILABLE,
            "recommendation_engine": True,  # From recommendation_engine.py
            "pivot_optimization": True,      # From pivot_engine.py
            "threshold_monitoring": True     # From threshold_manager.py
        },
        "ai_capabilities": [
            "Generate contextual activities based on trip preferences",
            "Optimize itineraries using real-time feedback",
            "Monitor fatigue and energy levels for safety",
            "Provide intelligent recommendations and alternatives",
            "Adapt activities based on group dynamics"
        ],
        "supported_locations": ["urban", "nature", "coastal", "mountain", "rural"],
        "supported_activity_types": ["physical", "cultural", "food", "relaxing", "adventurous", "educational"],
        "ai_configuration": {
            "gemini_api": "Configured" if AI_GENERATOR_AVAILABLE else "Not configured",
            "fallback_mode": "Active" if not AI_GENERATOR_AVAILABLE else "Inactive"
        },
        "timestamp": datetime.now().isoformat()
    }

if __name__ == "__main__":
    import uvicorn
    print("üöÄ AI-Powered Trip Management API with Activity Generation!")
    print(f"‚úÖ AI Generator Available: {AI_GENERATOR_AVAILABLE}")
    uvicorn.run(app, host="127.0.0.1", port=8001)